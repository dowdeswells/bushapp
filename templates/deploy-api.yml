
parameters:
- name: azureSubscription 
  type: string 
  default: 'bushapp-aus-east'

steps:

- download: current
  artifact: WebApp

- task: Bash@3
  inputs:
    targetType: 'inline'
    script: |
      # Write your commands here
      echo '$(Pipeline.Workspace)/WebApp'
      ls '$(Pipeline.Workspace)/WebApp'
  displayName: inner_ls

- task: AzureRmWebAppDeployment@4
  displayName: 'Deploy to linux Azure Web App'
  inputs:
    ConnectionType: 'AzureRM'
    azureSubscription: ${{ parameters.azureSubscription }}
    appType: 'webAppLinux'
    WebAppName: 'bushapp-api'
    packageForLinux: '$(Pipeline.Workspace)/WebApp/**/*.zip'
    RuntimeStack: 'DOTNETCORE|3.1'

- task: AzurePowerShell@5
  displayName: 'Import api into apim'
  inputs:
    azureSubscription: ${{ parameters.azureSubscription }}
    ScriptType: 'InlineScript'
    azurePowerShellVersion: latestVersion
    pwsh: true
    Inline: |
      $apim = Get-AzApiManagement `
        -ResourceGroupName 'bushapp-aus-east' `
        -Name 'bushapp-apim'

      $apimContext = New-AzApiManagementContext `
        -ResourceGroupName $apim.ResourceGroupName `
        -ServiceName $apim.Name

      $api = Import-AzApiManagementApi `
        -Context $apimContext `
        -ApiId 'bushapp-api' `
        -Path 'bushapp' `
        -SpecificationFormat 'Swagger' `
        -SpecificationPath '$(Pipeline.Workspace)/WebApp/swagger.json'        